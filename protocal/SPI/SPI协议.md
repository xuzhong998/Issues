# SPI配置

协商阶段:需要配置信号采集的时钟规则.

### **时钟频率**

SPI总线上的主机必须在通信开始时候配置并生成相应的时钟信号。在每个SPI时钟周期内，都会发生**全双工数据传输**。

主机在`MOSI`线上发送一位数据，从机读取它，而从机在`MISO`线上发送一位数据，主机读取它。

就算只进行单向的数据传输，也要保持这样的顺序。这就意味着无论接收任何数据，必须实际发送一些东西！在这种情况下，我们称其为虚拟数据；

从理论上讲，只要实际可行，时钟速率就可以是您想要的任何速率，当然这个速率受限于每个系统能提供多大的系统时钟频率，以及最大的SPI传输速率。

### **时钟极性 CKP/Clock Polarity**

除了配置串行时钟速率（频率）外，SPI主设备还需要配置**时钟极性**。

根据硬件制造商的命名规则不同，时钟极性通常写为**CKP**或**CPOL**。时钟极性和相位共同决定读取数据的方式，比如信号上升沿读取数据还是信号下降沿读取数据；

**CKP**可以配置为1或0。这意味着您可以根据需要将时钟的默认状态（IDLE）设置为高或低。极性反转可以通过简单的逻辑逆变器实现。您必须参考设备的数据手册才能正确设置CKP和CKE。

- `CKP = 0`：时钟空闲`IDLE`为低电平 `0`；
- `CKP = 1`：时钟空闲`IDLE`为高电平`1`；

### **时钟相位 CKE /Clock Phase (Edge)**

除配置串行时钟速率和极性外，SPI主设备还应配置时钟相位（或边沿）。根据硬件制造商的不同，时钟相位通常写为**CKE**或**CPHA**；

顾名思义，时钟相位/边沿，也就是采集数据时是在时钟信号的具体相位或者边沿；

- `CKE = 0`：在时钟信号`SCK`的第一个跳变沿采样；
- `CKE = 1`：在时钟信号`SCK`的第二个跳变沿采样；

**模式编号**

SPI的时钟极性和相位的配置通常称为 **SPI模式**，所有可能的模式都遵循以下约定；具体如下表所示；

| SPI Mode | CPOL | CPHA |
| -------- | ---- | ---- |
| 0 [00]   | 0    | 0    |
| 1 [01]   | 0    | 1    |
| 2 [10]   | 1    | 0    |
| 3 [11]   | 1    | 1    |

# SPI流程

整体的传输大概可以分为以下几个过程：

- 主机先将`NSS`信号拉低，这样保证开始接收数据；
- 当**接收端**检测到时钟的边沿信号时，它将立即读取**数据线**上的信号，这样就得到了一位数据（1`bit`）;
  由于时钟是随数据一起发送的，因此指定**数据的传输速度并不重要**，尽管设备将具有可以运行的最高速度（稍后我们将讨论选择合适的时钟边沿和速度）。
- **主机**发送到**从机**时：主机产生相应的时钟信号，然后数据**一位一位**地将从`MOSI`信号线上进行发送到从机；
- **主机**接收**从机**数据：如果从机需要将数据发送回主机，则主机将继续生成预定数量的时钟信号，并且从机会将数据通过`MISO`信号线发送；

具体如下图所示； 

![v2-069df3709fb1a0c5486acbf620890313_720w](D:\Issues\protocal\SPI\v2-069df3709fb1a0c5486acbf620890313_720w.webp)